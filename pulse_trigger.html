<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Ejenti Dashboard - Pulse Trigger Information</title>

    <!-- Bootstrap Core CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">

    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.10.16/css/dataTables.bootstrap.min.css" rel="stylesheet">

    <!-- DataTables Responsive CSS -->
    <link href="https://cdn.datatables.net/responsive/2.2.0/css/responsive.dataTables.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/startbootstrap-sb-admin-2/3.3.7+1/css/sb-admin-2.min.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- Local Common JS/CSS Library by Walter -->
    <link href="css\build_info.css" rel="stylesheet" type="text/css">
    <script src="js\common.js"></script>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.blockUI/2.70/jquery.blockUI.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.js"></script>

    <!-- DataTables JavaScript -->
    <script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.16/js/dataTables.bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.2.0/js/dataTables.responsive.min.js"></script>

    <!-- Localforage : Caching downloaded data-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.4.0/localforage.min.js"></script>
    <script src="js\cachedFetch.js"></script>

</head>

<body>

    <div id="title">Pulse Trigger Information</div>

        <script>
            $('body').block( {  
                message : '<h1> Loading Data from Remote ... </h1>',
                css : {  
                    border: 'none',
                    padding: '15px',
                    backgroundColor: '#000',
                    '-webkit-border-radius': '10px',
                    '-moz-border-radius': '10px',
                    opacity: .5,
                    color: '#fff',
                    position: 'fixed',
                    margin: 'auto'
                },
                centerY: false,
                centerX: false
            });
        </script>

    <div class="panel panel-info" style="width: 80%; margin:0px auto;">
        <div class="panel-body">
            <!-- Main Table -->
            <table id="dataTables" class="table table-bordered table-hover" cellspacing="0" width="100%">
                <thead>
                    <tr>
                        <th></th>
                        <th>Type</th>
                        <th>Command</th>
                        <th>Start Time</th>
                        <th>Latest Updated Time</th>
                        <th>Status</th>
                        <th>Description</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
    <br />

    <!-- Refresh Time -->
    <div class="col-lg-3.5" style="float: right; margin-right:9.2%;">
        <div class="panel panel-primary">
            <div class="panel-heading">
                <i class="fa fa-refresh fa-fw"></i> Page Refreshed Time: <label><script>document.write(new Date());</script></label><br />
                <i class="fa fa-clock-o fa-fw"></i> Data Acquired Time: <label id="data_acquired_time"></label><br />
            </div>
            <!-- /.panel-heading -->
        </div>
    </div>


    <!-- load agent data and translated to new object format-->
    <script>
        var pulse_trigger_url = "https://gist.githubusercontent.com/mozhasalstatus/6bd453e82c2aed31d9ca56021db410c8/raw/win10-hp-r1-10_recently.json?" + parseInt(current_timestamp/500000);
        var cached_data = cachedFetch(pulse_trigger_url);
        var additional_data = [];


        // Load Cached Data : Agents List
        var current_timestamp = Date.now();
        // var agents_list_url = "https://gist.githubusercontent.com/mozhasalstatus/cf4b97a3273e2f3117211a3663928133/raw/file_name_list.json?" + parseInt(current_timestamp/500000);
        var agents_list_url = "https://gist.githubusercontent.com/mozhasalstatus/23c1d64642e5838900c01a3ccbbaee7c/raw/file_name_list.json?" + parseInt(current_timestamp/500000);
        var cached_agents_list = cachedFetch(agents_list_url);
        var data_acquired_time = getCachedTime(agents_list_url);

        // Wait for document loaded and set data acquired time
        $(document).ready(function() {
            data_acquired_time.then(function(timestamp){
                document.getElementById("data_acquired_time").innerText = new Date(timestamp);
            });
        });

        var agent_list, agents_obj_list;

        cached_agents_list.then(function(input){
            agents_list = Object.keys(input);

            // Started to acquire all agent data
            agents_obj_list = new Array(agents_list.length);
            for(var i = 0; i < agents_list.length; i++) {
                agents_obj_list[i] = cachedFetch(input[agents_list[i]]["recently"]["raw_url"] + "?" + parseInt(current_timestamp/500000));
            }

            // wait till fulfilled and started to handle data
            Promise.all(agents_obj_list).then(function(agents_obj_data){
                all_agents_data = [];
                for(var i = 0; i < agents_obj_data.length; i++) {
                    all_agents_data = all_agents_data.concat(agents_obj_data[i].data);
                }
                console.log(page + ": All the agents' data successfully fetched.");

                $(document).ready(function() {
                    // Transfer to array for main table to be constructed
                    var output_full = jQuery.map(all_agents_data, function(dt, i) {
                        // var last_status_code = finder(Math.max, dt.status, function(x) { return parseInt(x.code); });
                        var latest_status = dt.status.getMax("code");
                        var start_datime = new Date(parseInt(dt.start_ts*1000)).toUTCString("en-US");
                        var last_datime = new Date(parseInt(latest_status.utc_timestamp*1000)).toUTCString("en-US");
                        
                        // check status
                        var status = "normal";
                        if (latest_status.code != "900") {
                            var time_diff = Date.now() - latest_status.utc_timestamp;
                            if ( time_diff > 1000 * 60 * 60 * 12 ) {
                                status = "error";
                            } else if ( time_diff > 1000 * 60 * 60 * 6) {
                                status = "warning";
                            }
                        }

                        // Sometimes, status code description 
                        if (latest_status.status_code_desc == null) {
                            latest_status.status_code_desc = "";
                        }

                        return [["", dt.type, dt.cmd, start_datime, last_datime, latest_status.code, latest_status.status_code_desc, status]];
                    });

                    // This only build up list containing incomplete output
                    var output_error = jQuery.map(all_agents_data, function(dt, i) {
                        // var last_status_code = finder(Math.max, dt.status, function(x) { return parseInt(x.code); });
                        var latest_status = dt.status.getMax("code");
                        var start_datime = new Date(parseInt(dt.start_ts*1000)).toUTCString("en-US");
                        var last_datime = new Date(parseInt(latest_status.utc_timestamp*1000)).toUTCString("en-US");
                        
                        // check status
                        var status = "normal";
                        if (latest_status.code != "900") {
                            var time_diff = Date.now() - latest_status.utc_timestamp;
                            if ( time_diff > 1000 * 60 * 60 * 12 ) {
                                status = "error";
                            } else if ( time_diff > 1000 * 60 * 60 * 6) {
                                status = "warning";
                            }
                        }
                        if(latest_status.code != "900") {
                            return [["", dt.type, dt.cmd, start_datime, last_datime, latest_status.code, latest_status.status_code_desc, dt.status, status]];
                        } else {
                            return ;
                        }
                    });

                    // Entry point of pulse data to table
                    var table = $('#dataTables').DataTable({
                        "aaData": output_full,
                        "aoColumns": [
                             {
                                 "className":      "details-control",
                                 "orderable":      false,
                                 "data":           null,
                                 "defaultContent": '<i class="fa fa-hand-o-right fa-fw fa-1x" style="text-align:center;"></i>'
                             },
                             { "sTitle": "Type" },
                             { "sTitle": "Command" },
                             { "sTitle": "Start Time" },
                             { "sTitle": "Latest Update Time" },
                             { "sTitle": "Status Code"},
                             { "sTitle": "Status Description"}
                        ],
                        "order": [[ 4, "desc" ]]
                    });

                    //TODO: Set Table Color / Should use css class for setting
                    //var output_length = output.length;
                    //for(var i = 0; i < output_length; i++) {
                    //    if(output[i][output[i].length - 1] == "error") {
                    //        $( "#dataTables tr:nth-child(" + (i+1) + ")" ).css( "background-color", "#f06666" );
                    //    } else if(output[i][output[i].length - 1] == "warning") {
                    //        $( "#dataTables tr:nth-child(" + (i+1) + ")" ).css( "background-color", "#f2f20b" );
                    //    }
                    //}

                    // Subarea: Detailed data
                    function format ( input_data ) {
                        // check if (Type, Command, Start Time) pair is correct
                        var filtered_data = all_agents_data.filter((obj) => 
                            (obj.type == input_data[1]) && obj.cmd == input_data[2] &&
                            ((new Date(parseInt(obj.start_ts*1000)).toUTCString("en-US")) == input_data[3]));

                        var title = "<div style='font-weight: bold;'>Details Data:</div>";
                        var content = "";
                        var status = filtered_data[0]['status'];

                        for(var i = status.length - 1; i >= 0; i--) {
                            // Using toString() will return local time
                            dtime = new Date(parseInt(status[i].utc_timestamp*1000)).toUTCString("en-US");
                            content += "<div>received " + status[i].code + " (" + status[i].status_code_desc + ") in " + dtime + "<\div>";
                        }
                        return '<div class="shown_table" style="background-color: lightgrey;">' + title + content + '</div>';
                    };

                    // Add event listener for opening and closing details
                    $('#dataTables tbody').on('click', 'td.details-control', function () {
                        var tr = $(this).closest('tr');
                        var row = table.row( tr );

                        if ( row.child.isShown() ) {
                            // This row is already open - close it
                            row.child.hide();
                            tr.removeClass('shown');
                        } else {
                            // Hide all shown details
                            console.log(page + ": hide shown columns")
                            $(".shown_table").parent().hide();
                            $(".shown").removeClass('shown');
                            // Open detailed data for selected column
                            console.log(page + ": show selected column")
                            row.child( format(row.data()) ).show();
                            tr.addClass('shown');
                        }
                    });

                    // Disabled Jquery blockUI
                    $.unblockUI();
                    });

            });

        });
    </script>
</body>

</html>
